<!DOCTYPE html>
<html>
<head>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://unpkg.com/jquery.terminal/js/jquery.terminal.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/jquery.terminal/css/jquery.terminal.min.css"/>
<script src="ping.js"></script>
</head>
<body>

<div id="terminal"></div>

<script>

var pinging, ad, timer, suc, total, loc;
$('#terminal').terminal(function(command, term) {
		var cmd = $.terminal.parse_command(command);
		var address = cmd.args[0];
		
		if (cmd.name == 'ping' && address != undefined) {
			loc = address;
			if(address.substring(0,7) != 'http://' && address.substring(0,8) != 'https://')
			{
				ad = "http://" + address;
			}
			else{
				ad = address;
			}
			term.echo("PING " + address);
            var i = 0;
            total = 0;
            suc = 0;
            var output = "";
            var p = new Ping();
            pinging = true;
            
            (function loop() {
                p.ping(ad, function(err, data) {
  					// Also display error if err is returned.
  					if (err || data >= 1500) {
    					output = "Request timeout for ping_seq " + i;
  					}
  					else{
  						output = "Transmission to " + address + ": ping_seq=" + i + " time=" + data + " ms";
  					}
				});
				
				if(output)
				{
					term.echo(output);
					total = i + 1;
					i++;
					if(output.substring(0,1) == 'T')
					{
						suc++;
					}
				}
				
				term.set_prompt("");
				p = new Ping();
				timer = setTimeout(loop, 1000);
            })();
        }
        else if (cmd.name == 'ping' && address == undefined) {
    		term.echo("ping: no address to ping");
        }
        else if (cmd.name){
        	term.echo(cmd.name + ": command not found");
        }
	}, 	
	{
    greetings: 'Connection to https://www.eagleyuan.com [[;green;]success]\n'+ 'Login time: ' + new Date() + '\n----------------------------\nThe program pings every second\nIf the response time is over 1.5 s, the ping times out\nStart by typing the ping command and the address as the argument \nStop the pinging by hitting CTRL and C at the same time\n----------------------------',
    width: 600,
    height: 350,
	prompt: "[[;white;]eagleyuan.com:projects visitor$ ]",
	keydown: function(e, term) {
        if (pinging) {
            if (e.which == 67 && e.ctrlKey) { // CTRL+c
            	term.echo("^C");
            	clearTimeout(timer);
            	pinging = false;
            	
            	term.echo("--- " + loc + " ping statistics ---");
            	
            	var ploss = (total - suc) * 100.0 / total;
            	var round = ploss.toFixed(1);
            	term.echo(total + " pings transmitted, " + suc + " successful pings, " + round + "% loss");
            	
            	term.set_prompt("[[;white;]eagleyuan.com:projects visitor$ ]");
            }
            return false;
        }
    }	
});

</script>

</body>
</html>